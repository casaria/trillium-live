/*! grafana - v4.5.0-beta1 - 2017-09-05
 * Copyright (c) 2017 Torkel Ã–degaard; Licensed Apache-2.0 */

System.register(["lodash","./query_def","app/core/table_model"],function(a,b){"use strict";function c(a,b){this.targets=a,this.response=b}b&&b.id;a("ElasticResponse",c);var d,e,f;return{setters:[function(a){d=a},function(a){e=a},function(a){f=a}],execute:function(){c.prototype.processMetrics=function(a,b,c,d){var e,f,g,h,i,j;for(f=0;f<b.metrics.length;f++)if(e=b.metrics[f],!e.hide)switch(e.type){case"count":for(h={datapoints:[],metric:"count",props:d},g=0;g<a.buckets.length;g++)i=a.buckets[g],j=i.doc_count,h.datapoints.push([j,i.key]);c.push(h);break;case"percentiles":if(0===a.buckets.length)break;var k=a.buckets[0],l=k[e.id].values;for(var m in l){for(h={datapoints:[],metric:"p"+m,props:d,field:e.field},g=0;g<a.buckets.length;g++){i=a.buckets[g];var n=i[e.id].values;h.datapoints.push([n[m],i.key])}c.push(h)}break;case"extended_stats":for(var o in e.meta)if(e.meta[o]){for(h={datapoints:[],metric:o,props:d,field:e.field},g=0;g<a.buckets.length;g++){i=a.buckets[g];var p=i[e.id];p.std_deviation_bounds_upper=p.std_deviation_bounds.upper,p.std_deviation_bounds_lower=p.std_deviation_bounds.lower,h.datapoints.push([p[o],i.key])}c.push(h)}break;default:for(h={datapoints:[],metric:e.type,field:e.field,props:d},g=0;g<a.buckets.length;g++)i=a.buckets[g],j=i[e.id],void 0!==j&&(j.normalized_value?h.datapoints.push([j.normalized_value,i.key]):h.datapoints.push([j.value,i.key]));c.push(h)}},c.prototype.processAggregationDocs=function(a,b,c,e,f){if(0===e.columns.length){for(var g=0,h=d.default.keys(f);g<h.length;g++){var i=h[g];e.addColumn({text:i,filterable:!0})}e.addColumn({text:b.field,filterable:!0})}for(var j=function(a,b,c){e.addColumn({text:b}),a.push(c)},k=0,l=a.buckets;k<l.length;k++){for(var m=l[k],n=[],o=0,p=d.default.values(f);o<p.length;o++){var q=p[o];n.push(q)}n.push(m.key);for(var r=0,s=c.metrics;r<s.length;r++){var t=s[r];switch(t.type){case"count":j(n,this._getMetricName(t.type),m.doc_count);break;case"extended_stats":for(var u in t.meta)if(t.meta[u]){var v=m[t.id];v.std_deviation_bounds_upper=v.std_deviation_bounds.upper,v.std_deviation_bounds_lower=v.std_deviation_bounds.lower,j(n,this._getMetricName(u),v[u])}break;default:var w=this._getMetricName(t.type),x=d.default.filter(c.metrics,{type:t.type});x.length>1&&(w+=" "+t.field),j(n,w,m[t.id].value)}}e.rows.push(n)}},c.prototype.processBuckets=function(a,b,c,e,f,g){var h,i,j,k,l=b.bucketAggs.length-1;for(k in a)if(i=d.default.find(b.bucketAggs,{id:k}),j=a[k],i)if(g===l)"date_histogram"===i.type?this.processMetrics(j,b,c,f):this.processAggregationDocs(j,i,b,e,f);else for(var m in j.buckets)h=j.buckets[m],f=d.default.clone(f),void 0!==h.key?f[i.field]=h.key:f.filter=m,h.key_as_string&&(f[i.field]=h.key_as_string),this.processBuckets(h,b,c,e,f,g+1)},c.prototype._getMetricName=function(a){var b=d.default.find(e.default.metricAggTypes,{value:a});return b||(b=d.default.find(e.default.extendedStats,{value:a})),b?b.text:a},c.prototype._getSeriesName=function(a,b,c){var f=this._getMetricName(a.metric);if(b.alias){var g=/\{\{([\s\S]+?)\}\}/g;return b.alias.replace(g,function(b,c,d){var e=c||d;return 0===e.indexOf("term ")?a.props[e.substring(5)]:void 0!==a.props[e]?a.props[e]:"metric"===e?f:"field"===e?a.field:b})}if(a.field&&e.default.isPipelineAgg(a.metric)){var h=d.default.find(b.metrics,{id:a.field});h?f+=" "+e.default.describeMetric(h):f="Unset"}else a.field&&(f+=" "+a.field);var i=d.default.keys(a.props);if(0===i.length)return f;var j="";for(var k in a.props)j+=a.props[k]+" ";return 1===c?j.trim():j.trim()+" "+f},c.prototype.nameSeries=function(a,b){for(var c=d.default.uniq(d.default.map(a,"metric")).length,e=d.default.uniq(d.default.map(a,"field")).length,f=0;f<a.length;f++){var g=a[f];g.target=this._getSeriesName(g,b,c,e)}},c.prototype.processHits=function(a,b){var c,d,e,f,g={target:"docs",type:"docs",datapoints:[],total:a.total,filterable:!0};for(f=0;f<a.hits.length;f++){if(d=a.hits[f],e={_id:d._id,_type:d._type,_index:d._index},d._source)for(c in d._source)e[c]=d._source[c];for(c in d.fields)e[c]=d.fields[c];g.datapoints.push(e)}b.push(g)},c.prototype.trimDatapoints=function(a,b){var c=d.default.find(b.bucketAggs,{type:"date_histogram"}),e=c&&c.settings&&c.settings.trimEdges;if(e){var f=c.settings.trimEdges;for(var g in a){var h=a[g];h.datapoints.length>2*f&&(h.datapoints=h.datapoints.slice(f,h.datapoints.length-f))}}},c.prototype.getErrorFromElasticResponse=function(a,b){var c={};return c.data=JSON.stringify(b,null,4),b.root_cause&&b.root_cause.length>0&&b.root_cause[0].reason?c.message=b.root_cause[0].reason:c.message=b.reason||"Unkown elatic error response",a.$$config&&(c.config=a.$$config),c},c.prototype.getTimeSeries=function(){for(var a=[],b=0;b<this.response.responses.length;b++){var c=this.response.responses[b];if(c.error)throw this.getErrorFromElasticResponse(this.response,c.error);if(c.hits&&c.hits.hits.length>0&&this.processHits(c.hits,a),c.aggregations){var d=c.aggregations,e=this.targets[b],g=[],h=new f.default;this.processBuckets(d,e,g,h,{},0),this.trimDatapoints(g,e),this.nameSeries(g,e);for(var i=0;i<g.length;i++)a.push(g[i]);h.rows.length>0&&a.push(h)}}return{data:a}}}}});
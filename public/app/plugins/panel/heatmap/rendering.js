/*! grafana - v4.5.0-beta1 - 2017-09-05
 * Copyright (c) 2017 Torkel Ã–degaard; Licensed Apache-2.0 */

System.register(["lodash","jquery","moment","app/core/utils/kbn","app/core/core","app/core/utils/ticks","d3","./heatmap_tooltip","./heatmap_data_converter"],function(a,b){"use strict";function c(a,b,c,y){function z(){try{var a=y.height||ma.height||y.row.height;return g.default.isString(a)&&(a=parseInt(a.replace("px",""),10)),a-=5,a-=ma.title?24:9,Fa.css("height",a+"px"),!0}catch(a){return!1}}function A(a){var b=a.selectAll(".axis-y text").nodes(),c=g.default.max(g.default.map(b,function(a){var b=h.default(a);return b.outerWidth()}));return c}function B(a){var b=a.select(".axis-x line");if(b.empty())return 30;var c=parseFloat(a.select(".axis-x line").attr("y2")),d=parseFloat(a.attr("height"));return d-c}function C(){a.xScale=ra=m.default.scaleTime().domain([la.from,la.to]).range([0,sa]);var b,c=sa/t,e=d(c,la.from,la.to),f=y.dashboard.getTimezone();b="utc"===f?m.default.utcFormat(e):m.default.timeFormat(e);var g=m.default.axisBottom(ra).ticks(c).tickFormat(b).tickPadding(v).tickSize(ta),h=Ja.top,i=wa;na.append("g").attr("class","axis axis-x").attr("transform","translate("+i+","+h+")").call(g),na.select(".axis-x").select(".domain").remove()}function D(){var b=Math.ceil(ta/u),c=l.tickStep(ka.heatmapStats.min,ka.heatmapStats.max,b),d=E(ka.heatmapStats.min,ka.heatmapStats.max,c),e=d.y_min,h=d.y_max;e=null!==ma.yAxis.min?ma.yAxis.min:e,h=null!==ma.yAxis.max?ma.yAxis.max:h,c=l.tickStep(e,h,b),b=Math.ceil((h-e)/c);var i=f(c),j=null===ma.yAxis.decimals?i:ma.yAxis.decimals,k=l.getFlotTickSize(e,h,b,i),n=l.getScaledDecimals(j,k);y.decimals=j,y.scaledDecimals=n,g.default.isEmpty(ka.buckets)&&(h=1,e=-1,b=3,j=1),ka.yAxis={min:e,max:h,ticks:b},a.yScale=qa=m.default.scaleLinear().domain([e,h]).range([ta,0]);var o=m.default.axisLeft(qa).ticks(b).tickFormat(K(j,n)).tickSizeInner(0-oa).tickSizeOuter(0).tickPadding(w);na.append("g").attr("class","axis axis-y").call(o);var p=Ja.top,q=A(na)+w;na.select(".axis-y").attr("transform","translate("+q+","+p+")"),na.select(".axis-y").select(".domain").remove()}function E(a,b,c){var d,e,f=(b*(Ka-1)-a*(Ka-1))/2;return 0===c?(e=b*Ka,d=a-a*(Ka-1),c=(e-d)/2):(e=Math.ceil((b+f)/c)*c,d=Math.floor((a-f)/c)*c),a>=0&&d<0&&(d=0),{y_min:d,y_max:e}}function F(){var b=ma.yAxis.logBase,c=G(ka.heatmapStats.minLog,ka.heatmapStats.max,b),d=c.y_min,e=c.y_max;d=ma.yAxis.min&&"0"!==ma.yAxis.min?I(ma.yAxis.min,b):d,e=null!==ma.yAxis.max?H(ma.yAxis.max,b):e,g.default.isEmpty(ka.buckets)&&(e=Math.pow(b,2),d=1),a.yScale=qa=m.default.scaleLog().base(ma.yAxis.logBase).domain([d,e]).range([ta,0]);var h=qa.domain(),i=J(h,b),j=f(d),k=ma.yAxis.decimals||j,n=l.getFlotTickSize(d,e,i.length,j),o=l.getScaledDecimals(k,n);y.decimals=k,y.scaledDecimals=o,ka.yAxis={min:d,max:e,ticks:i.length};var p=m.default.axisLeft(qa).tickValues(i).tickFormat(K(k,o)).tickSizeInner(0-oa).tickSizeOuter(0).tickPadding(w);na.append("g").attr("class","axis axis-y").call(p);var q=Ja.top,r=A(na)+w;na.select(".axis-y").attr("transform","translate("+r+","+q+")"),d<1&&na.select(".axis-y").select(".tick text").text("0"),na.select(".axis-y").select(".domain").remove()}function G(a,b,c){var d,e;return d=ka.heatmapStats.minLog,d=ka.heatmapStats.minLog>1||!ka.heatmapStats.minLog?1:I(ka.heatmapStats.minLog,c),e=H(ka.heatmapStats.max,c),{y_min:d,y_max:e}}function H(a,b){return Math.pow(b,Math.ceil(e(a,b)))}function I(a,b){return Math.pow(b,Math.floor(e(a,b)))}function J(a,b){var c=a[0],d=a[1],f=[];if(c<1)for(var g=Math.floor(e(c,b)),h=g;h<0;h++){var i=Math.pow(b,h);f.push(i)}for(var j=Math.ceil(e(d,b)),h=0;h<=j;h++){var i=Math.pow(b,h);f.push(i)}return f}function K(a,b){void 0===b&&(b=null);var c=ma.yAxis.format;return function(d){return j.default.valueFormats[c](d,a,b)}}function L(){na.select(".axis-y").selectAll(".tick line").attr("x2",sa)}function M(){ta=pa-Ja.top-Ja.bottom,ua=Ja.top,va=ua+ta,1===ma.yAxis.logBase?D():F(),wa=A(na)+w,sa=oa-wa-Ja.right,L(),C(),xa=B(na),ma.yAxis.show||na.select(".axis-y").selectAll("line").style("opacity",0),ma.xAxis.show||na.select(".axis-x").selectAll("line").style("opacity",0)}function N(){var a=Fa[0];oa=Math.floor(Fa.width())-Ia.right,pa=Math.floor(Fa.height())-Ia.bottom,ya=null!==ma.cards.cardPadding?ma.cards.cardPadding:q,za=null!==ma.cards.cardRound?ma.cards.cardRound:r,na&&na.remove(),na=m.default.select(a).append("svg").attr("width",oa).attr("height",pa)}function O(){if(N(),M(),1!==ma.yAxis.logBase){var a=ma.yAxis.logBase,b=qa.domain(),c=J(b,a);ka.buckets=o.mergeZeroBuckets(ka.buckets,g.default.min(c))}var d=ka.cards,e=ka.cardStats.max,f=ma.color.max||e,h=ma.color.min||0;Ca=R(f,h),S(f),T();var i=na.selectAll(".heatmap-card").data(d);i.append("title"),i=i.enter().append("rect").attr("x",U).attr("width",V).attr("y",W).attr("height",X).attr("rx",za).attr("ry",za).attr("class","bordered heatmap-card").style("fill",Y).style("stroke",Y).style("stroke-width",0).style("opacity",Z);var j=Fa.find(".heatmap-card");j.on("mouseenter",function(a){Ga.mouseOverBucket=!0,P(a)}).on("mouseleave",function(a){Ga.mouseOverBucket=!1,Q(a)})}function P(a){var b=m.default.select(a.target).style("fill"),c=m.default.color(b).darker(2),d=m.default.color(b).brighter(4),e=m.default.select(a.target);Ga.originalFillColor=b,e.style("fill",c).style("stroke",d).style("stroke-width",1)}function Q(a){m.default.select(a.target).style("fill",Ga.originalFillColor).style("stroke",Ga.originalFillColor).style("stroke-width",0)}function R(a,b){void 0===b&&(b=0);var c=g.default.find(y.colorSchemes,{value:ma.color.colorScheme}),d=m.default[c.value],e="always"===c.invert||"dark"===c.invert&&!k.contextSrv.user.lightTheme,f=e?a:b,h=e?b:a;return m.default.scaleSequential(d).domain([f,h])}function S(a){"linear"===ma.color.colorScale?Da=m.default.scaleLinear().domain([0,a]).range([0,1]):"sqrt"===ma.color.colorScale&&(Da=m.default.scalePow().exponent(ma.color.exponent).domain([0,a]).range([0,1]))}function T(){var a=Math.floor(ra(ka.xBucketSize)-ra(0)),b=Math.floor(qa(qa.invert(0)-ka.yBucketSize));if(1!==ma.yAxis.logBase){var c=ma.yAxis.logBase,d=ka.yBucketSize||1;b=Math.floor((qa(1)-qa(c))/d)}Aa=a-2*ya,Ba=b?b-2*ya:0}function U(a){var b;return b=ra(a.x)<0?wa+ya:ra(a.x)+wa+ya}function V(a){var b;if(ra(a.x)<0){var c=ra(a.x)+Aa;b=c>0?c:0}else b=ra(a.x)+Aa>sa?sa-ra(a.x)-ya:Aa;return b=Math.max(b,p)}function W(a){var b=qa(a.y)+ua-Ba-ya;return 1!==ma.yAxis.logBase&&0===a.y?b=va-Ba-ya:b<ua&&(b=ua),b}function X(a){var b=qa(a.y)+ua-Ba-ya,c=Ba;return 1!==ma.yAxis.logBase&&0===a.y?Ba:(b<ua?c=qa(a.y)-ya:qa(a.y)>va?c=va-b:b+Ba>va&&(c=va-b),c=Math.min(c,ta),c=Math.max(c,p))}function Y(a){return"opacity"===ma.color.mode?ma.color.cardColor:Ca(a.count)}function Z(a){return"opacity"===ma.color.mode?Da(a.count):1}function $(a){Ha.active=!0,Ha.x1=a.offsetX,Ea=function(){_()},h.default(document).one("mouseup",Ea)}function _(){h.default(document).unbind("mouseup",Ea),Ea=null,Ha.active=!1;var a=Math.abs(Ha.x2-Ha.x1);if(Ha.x2>=0&&a>x){var b=ra.invert(Math.min(Ha.x1,Ha.x2)-wa),c=ra.invert(Math.max(Ha.x1,Ha.x2)-wa);y.timeSrv.setTime({from:i.default.utc(b),to:i.default.utc(c)})}fa()}function aa(){k.appEvents.emit("graph-hover-clear"),ia()}function ba(a){na&&(Ha.active?(ia(),Ga.destroy(),Ha.x2=da(a.offsetX),ea(Ha.x1,Ha.x2)):(ca(a),ga(a.offsetX),Ga.show(a,ka)))}function ca(a){var b=ra.invert(a.offsetX-wa).valueOf(),c=qa.invert(a.offsetY),d={pageX:a.pageX,pageY:a.pageY,x:b,x1:b,y:c,y1:c,panelRelY:null};d.panelRelY=Math.max(a.offsetY/pa,.001),k.appEvents.emit("graph-hover",{pos:d,panel:ma})}function da(a){return a=Math.max(a,wa),a=Math.min(a,sa+wa)}function ea(a,b){if(na){na.selectAll(".heatmap-selection").remove();var c=Math.min(a,b),d=Math.abs(a-b);d>x&&na.append("rect").attr("class","heatmap-selection").attr("x",c).attr("width",d).attr("y",ua).attr("height",ta)}}function fa(){Ha.x1=-1,Ha.x2=-1,na&&na.selectAll(".heatmap-selection").remove()}function ga(a){if(na){na.selectAll(".heatmap-crosshair").remove();var b=a;b=Math.max(b,wa),b=Math.min(b,sa+wa),na.append("g").attr("class","heatmap-crosshair").attr("transform","translate("+b+",0)").append("line").attr("x1",1).attr("y1",ua).attr("x2",1).attr("y2",va).attr("stroke-width",1)}}function ha(a){if(na&&0!==y.dashboard.graphTooltip){var b=ra(a.x)+wa;ga(b)}}function ia(){na&&na.selectAll(".heatmap-crosshair").remove()}function ja(){if(ka=y.data,ma=y.panel,la=y.range,z()&&ka){if(g.default.isEmpty(ka.buckets))return N(),void M();O(),a.yAxisWidth=wa,a.xAxisHeight=xa,a.chartHeight=ta,a.chartWidth=sa,a.chartTop=ua}}var ka,la,ma,na,oa,pa,qa,ra,sa,ta,ua,va,wa,xa,ya,za,Aa,Ba,Ca,Da,Ea,Fa=b.find(".heatmap-panel"),Ga=new n.HeatmapTooltip(Fa,a),Ha={active:!1,x1:-1,x2:-1},Ia={left:0,right:0,top:0,bottom:0},Ja={left:25,right:15,top:10,bottom:20},Ka=s;y.events.on("render",function(){ja(),y.renderingCompleted()}),k.appEvents.on("graph-hover",function(a){ha(a.pos)},a),k.appEvents.on("graph-hover-clear",function(){ia()},a),Fa.on("mousedown",$),Fa.on("mousemove",ba),Fa.on("mouseleave",aa)}function d(a,b,c){if(b&&c&&a){var d=c-b,e=d/a/1e3,f=864e5,g=31536e6;return e<=45?"%H:%M:%S":e<=7200||d<=f?"%H:%M":e<=8e4?"%m/%d %H:%M":e<=2419200||d<=g?"%m/%d":"%Y-%m"}return"%H:%M"}function e(a,b){return Math.log(a)/Math.log(b)}function f(a){var b=a.toString(),c=b.indexOf(".");return c===-1?0:b.length-c-1}b&&b.id;a("default",c);var g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x;return{setters:[function(a){g=a},function(a){h=a},function(a){i=a},function(a){j=a},function(a){k=a},function(a){l=a},function(a){m=a},function(a){n=a},function(a){o=a}],execute:function(){p=1,q=1,r=0,s=1.2,t=100,u=50,v=10,w=5,x=2}}});